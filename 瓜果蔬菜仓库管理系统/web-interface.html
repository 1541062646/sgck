<!DOCTYPE html>
<html>
<head>
    <title>æ™ºèƒ½ä»“å‚¨ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --warning-color: #ff4757;
            --safe-color: #2ed573;
            --primary-color: #3498db;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            background: #f5f7fa;
            margin: 0;
            min-height: 100vh;
        }
        h1 {
            grid-column: 1 / -1;
            text-align: center;
            color: #2c3e50;
            margin: 20px 0;
        }
        .control-panel {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .sensor-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
            text-align: center;
        }
        .warning {
            animation: pulse 1s infinite;
            border: 2px solid var(--warning-color);
        }
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        .value {
            font-size: 36px;
            font-weight: 600;
            margin: 15px 0;
        }
        .unit {
            color: #666;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        input[type="number"], input[type="text"], input[type="password"], input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 120px;
        }
        #analysisResult {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .threshold-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sensor-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        #connectionStatus {
            padding: 10px;
            border-radius: 20px;
            text-align: center;
            background: #e74c3c;
            color: white;
            margin-top: 10px;
        }
        .connected {
            background: #2ecc71 !important;
        }
    </style>
</head>
<body>
    <h1>ğŸ æ™ºèƒ½æ°´æœä»“å‚¨ç®¡ç†ç³»ç»Ÿ ğŸŒ</h1>

    <div class="control-panel">
        <div class="config-section">
            <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
            <button id="connectBtn">ğŸ”— è¿æ¥ä¼ æ„Ÿå™¨è®¾å¤‡</button>
            <div id="connectionStatus">æœªè¿æ¥</div>
            <div style="margin-top: 20px;">
                <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥é˜¿é‡Œç™¾ç‚¼APIå¯†é’¥" style="width: 300px;">
                <button onclick="saveApiKey()">ä¿å­˜å¯†é’¥</button>
            </div>
        </div>

        <div class="config-section">
            <h2>âš ï¸ é¢„è­¦å‚æ•°è®¾ç½®</h2>
            <div class="threshold-item">
                <span>ğŸŒ¡ï¸ æ¸©åº¦(Â°C):</span>
                <input type="number" id="tempMin" placeholder="æœ€ä½å€¼">
                <input type="number" id="tempMax" placeholder="æœ€é«˜å€¼">
            </div>
            <div class="threshold-item">
                <span>ğŸ’§ æ¹¿åº¦(%RH):</span>
                <input type="number" id="humiMin" placeholder="æœ€ä½å€¼">
                <input type="number" id="humiMax" placeholder="æœ€é«˜å€¼">
            </div>
            <div class="threshold-item">
                <span>âš ï¸ COæµ“åº¦:</span>
                <input type="number" id="mq7Max" placeholder="æœ€é«˜å€¼">
            </div>
            <div class="threshold-item">
                <span>â˜ï¸ COâ‚‚æµ“åº¦:</span>
                <input type="number" id="mq135Max" placeholder="æœ€é«˜å€¼">
            </div>
            <div class="threshold-item">
                <span>ğŸ’¡ å…‰ç…§(lux):</span>
                <input type="number" id="luxMax" placeholder="æœ€é«˜å€¼">
            </div>
            <button onclick="saveThresholds()" style="margin-top: 15px;">ğŸ’¾ ä¿å­˜é¢„è­¦è®¾ç½®</button>
        </div>
    </div>

    <div class="sensor-grid">
        <div class="sensor-card">
            <h2>ğŸŒ¡ï¸ å®æ—¶æ¸©åº¦</h2>
            <div class="value temp" id="temperature">--.-</div>
            <div class="unit">Â°C</div>
        </div>
        <div class="sensor-card">
            <h2>ğŸ’§ å®æ—¶æ¹¿åº¦</h2>
            <div class="value humi" id="humidity">--.-</div>
            <div class="unit">% RH</div>
        </div>
        <div class="sensor-card">
            <h2>âš ï¸ COæµ“åº¦</h2>
            <div class="value gas" id="mq7">----</div>
            <div class="unit">RAW ADC</div>
        </div>
        <div class="sensor-card">
            <h2>â˜ï¸ COâ‚‚æµ“åº¦</h2>
            <div class="value gas" id="mq135">----</div>
            <div class="unit">RAW ADC</div>
        </div>
        <div class="sensor-card">
            <h2>ğŸ’¡ å…‰ç…§å¼ºåº¦</h2>
            <div class="value light" id="lux">--.-</div>
            <div class="unit">lux</div>
        </div>
    </div>

    <div id="analysisResult">
        <h2>ğŸ“Š å®æ—¶ä¿é²œåˆ†ææŠ¥å‘Š</h2>
        <div id="analysisContent">ç­‰å¾…é¦–æ¬¡åˆ†ææ•°æ®...</div>
    </div>

    <script>
        // ç³»ç»ŸçŠ¶æ€å˜é‡
        let port = null;
        let sensorData = {};
        const decoder = new TextDecoder();
        let analysisInterval = null;

        // åˆå§‹åŒ–é…ç½®
        let thresholds = JSON.parse(localStorage.getItem('thresholds')) || {
            temp: { min: 10, max: 25 },
            humi: { min: 40, max: 70 },
            mq7: { max: 500 },
            mq135: { max: 800 },
            lux: { max: 1000 }
        };

        // åˆå§‹åŒ–é¡µé¢
        function initSettings() {
            // é¢„è­¦è®¾ç½®
            document.getElementById('tempMin').value = thresholds.temp.min;
            document.getElementById('tempMax').value = thresholds.temp.max;
            document.getElementById('humiMin').value = thresholds.humi.min;
            document.getElementById('humiMax').value = thresholds.humi.max;
            document.getElementById('mq7Max').value = thresholds.mq7.max;
            document.getElementById('mq135Max').value = thresholds.mq135.max;
            document.getElementById('luxMax').value = thresholds.lux.max;
            
            // APIå¯†é’¥
            document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
            
            // å¯åŠ¨è‡ªåŠ¨åˆ†æ
            if (!analysisInterval) {
                analysisInterval = setInterval(performAnalysis, 300000); // æ¯5åˆ†é’Ÿåˆ†æä¸€æ¬¡
            }
        }

        // ä¿å­˜é¢„è­¦è®¾ç½®
        function saveThresholds() {
            thresholds = {
                temp: {
                    min: parseInt(document.getElementById('tempMin').value) || 0,
                    max: parseInt(document.getElementById('tempMax').value) || 50
                },
                humi: {
                    min: parseInt(document.getElementById('humiMin').value) || 0,
                    max: parseInt(document.getElementById('humiMax').value) || 100
                },
                mq7: { max: parseInt(document.getElementById('mq7Max').value) || 1000 },
                mq135: { max: parseInt(document.getElementById('mq135Max').value) || 1500 },
                lux: { max: parseInt(document.getElementById('luxMax').value) || 2000 }
            };
            localStorage.setItem('thresholds', JSON.stringify(thresholds));
            checkThresholds();
            alert('é¢„è­¦è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // ä¿å­˜APIå¯†é’¥
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            localStorage.setItem('apiKey', apiKey);
            alert('APIå¯†é’¥å·²ä¿å­˜ï¼');
        }

        // è¿æ¥ä¼ æ„Ÿå™¨
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                updateConnectionStatus(true);
                
                const reader = port.readable.getReader();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const dataString = decoder.decode(value);
                    processSensorData(dataString);
                }
            } catch (error) {
                updateConnectionStatus(false);
                console.error('è¿æ¥é”™è¯¯:', error);
                alert('ä¼ æ„Ÿå™¨è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®
        function processSensorData(data) {
            const sensorMap = {
                'TEMP': 'temperature',
                'HUMI': 'humidity',
                'MQ7': 'mq7',
                'MQ135': 'mq135',
                'LUX': 'lux'
            };

            data.split(',').forEach(pair => {
                const [key, value] = pair.split(':');
                if (sensorMap[key]) {
                    const numValue = parseFloat(value);
                    sensorData[key] = numValue;
                    const element = document.getElementById(sensorMap[key]);
                    element.textContent = key.startsWith('MQ') ? Math.round(numValue) : numValue.toFixed(1);
                }
            });

            checkThresholds();
        }

        // æ£€æŸ¥é˜ˆå€¼é¢„è­¦
        function checkThresholds() {
            document.querySelectorAll('.sensor-card').forEach(card => card.classList.remove('warning'));

            if (sensorData.TEMP < thresholds.temp.min || sensorData.TEMP > thresholds.temp.max) {
                document.getElementById('temperature').parentElement.classList.add('warning');
            }
            if (sensorData.HUMI < thresholds.humi.min || sensorData.HUMI > thresholds.humi.max) {
                document.getElementById('humidity').parentElement.classList.add('warning');
            }
            if (sensorData.MQ7 > thresholds.mq7.max) {
                document.getElementById('mq7').parentElement.classList.add('warning');
            }
            if (sensorData.MQ135 > thresholds.mq135.max) {
                document.getElementById('mq135').parentElement.classList.add('warning');
            }
            if (sensorData.LUX > thresholds.lux.max) {
                document.getElementById('lux').parentElement.classList.add('warning');
            }
        }

        // æ‰§è¡Œæ™ºèƒ½åˆ†æ
        async function performAnalysis() {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey) {
                alert('è¯·å…ˆè®¾ç½®é˜¿é‡Œç™¾ç‚¼APIå¯†é’¥ï¼');
                return;
            }

            const prompt = `ä½œä¸ºä»“å‚¨ç®¡ç†ä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹å®æ—¶æ•°æ®ç»™å‡ºä¸“ä¸šåˆ†æï¼š
            
            ç¯å¢ƒå‚æ•°ï¼š
            - æ¸©åº¦ï¼š${sensorData.TEMP || 0}Â°C 
            - æ¹¿åº¦ï¼š${sensorData.HUMI || 0}% RH
            - COæµ“åº¦ï¼š${sensorData.MQ7 || 0}
            - COâ‚‚æµ“åº¦ï¼š${sensorData.MQ135 || 0}
            - å…‰ç…§å¼ºåº¦ï¼š${sensorData.LUX || 0}lux

            ä»“å‚¨è¦æ±‚ï¼š
            - æœ€ä½³æ¸©åº¦èŒƒå›´ï¼š${thresholds.temp.min}-${thresholds.temp.max}Â°C
            - æœ€ä½³æ¹¿åº¦èŒƒå›´ï¼š${thresholds.humi.min}-${thresholds.humi.max}% RH

            è¯·åˆ†æï¼š
            1. å½“å‰ç¯å¢ƒå¯¹æ°´æœç³–åˆ†æµå¤±çš„å½±å“
            2. å…·ä½“ä¿é²œå»ºè®®ï¼ˆåˆ†ç‚¹åˆ—å‡ºï¼‰
            3. éœ€è¦ç«‹å³é‡‡å–çš„æªæ–½ï¼ˆå¦‚æœ‰ï¼‰
            
            è¯·ç”¨ä¸­æ–‡ä»¥ä¸“ä¸šä½†æ˜“æ‡‚çš„æ–¹å¼å›ç­”ï¼š`;

            try {
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "deepseek-r1",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;
                document.getElementById('analysisContent').innerHTML = content.replace(/\n/g, '<br>');
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥ï¼');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = connected ? 'å·²è¿æ¥ä¼ æ„Ÿå™¨' : 'æœªè¿æ¥';
            statusElement.className = connected ? 'connected' : '';
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        document.getElementById('connectBtn').addEventListener('click', connectSerial);
        window.addEventListener('load', initSettings);
    </script>
</body>
</html>
